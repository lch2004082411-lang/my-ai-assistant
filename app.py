import streamlit as st
from openai import OpenAI

# ==========================================
# 1. å‡†å¤‡å¤§æ¨¡å‹çš„ "å¤§è„‘" (åˆå§‹åŒ– API)
# ==========================================
# è¿™é‡Œä»¥å…¼å®¹ OpenAI æ ¼å¼çš„ DeepSeek ä¸ºä¾‹
# è¯·å°† "ä½ çš„API_KEY" æ›¿æ¢æˆä½ çœŸå®ç”³è¯·åˆ°çš„ Key
client = OpenAI(
    # âš ï¸ æ‹”å‡ºçœŸå®çš„é’¥åŒ™ï¼Œæ¢æˆä»äº‘ç«¯ä¿é™©ç®±(secrets)è¯»å–
    api_key=st.secrets["DEEPSEEK_API_KEY"], 
    base_url="https://api.deepseek.com"
)

# ==========================================
# 2. æ­å»ºç½‘é¡µç•Œé¢çš„ "å¤–å£³"
# ==========================================
st.set_page_config(page_title="æˆ‘çš„ç¬¬ä¸€ä¸ª AI åŠ©æ‰‹", page_icon="ğŸ¤–")
st.title("ğŸ¤– æˆ‘çš„ä¸“å± AI å°åŠ©æ‰‹")
# ==========================================
# ğŸ’ æ–°å¢åŠŸèƒ½ï¼šå·¦ä¾§è¾¹æ ä¸æ¸…ç©ºå¯¹è¯æŒ‰é’®
# ==========================================
with st.sidebar:
    st.header("âš™ï¸ æ§åˆ¶é¢æ¿")
    # å¦‚æœç‚¹å‡»äº†â€œæ¸…ç©ºå¯¹è¯â€æŒ‰é’®
    if st.button("ğŸ§¹ ä¸€é”®æ¸…ç©ºå¯¹è¯"):
        # æŠŠå¤§æ¨¡å‹çš„è®°å¿†æ¢å¤åˆ°å‡ºå‚çš„â€œè€å¸ˆâ€çŠ¶æ€
        st.session_state.messages = [
            {"role": "system", "content": "ä½ æ˜¯ä¸€ä½æ¸©å’Œå„’é›…ã€åšå­¦å¤šæ‰çš„è€å¸ˆã€‚æ— è®ºç”¨æˆ·é—®ä»€ä¹ˆé—®é¢˜ï¼Œå“ªæ€•æ˜¯å¾ˆåŸºç¡€çš„ä»£ç æŠ¥é”™ï¼Œä½ éƒ½ä¼šæå…·è€å¿ƒåœ°è§£ç­”ï¼Œè¯­æ°”æ¸©å’Œã€å……æ»¡é¼“åŠ±ã€‚åœ¨è§£é‡Šå¤æ‚æ¦‚å¿µæ—¶ï¼Œä½ å–œæ¬¢å¨“å¨“é“æ¥ï¼Œå¹¶å–„ç”¨é€šä¿—æ˜“æ‡‚çš„ç”ŸåŠ¨æ¯”å–»ã€‚ä½ çš„å›å¤æ€»æ˜¯è®©äººæ„Ÿåˆ°å¦‚æ²æ˜¥é£ã€è±ç„¶å¼€æœ—ã€‚"}, 
            {"role": "assistant", "content": "ä½ å¥½ï¼ŒåŒå­¦ã€‚æ±‚çŸ¥ä¹‹è·¯æ¼«æ¼«ï¼Œéš¾å…ä¼šé‡åˆ°äº›è®¸å›°æƒ‘ã€‚ä¸è¦ç€æ€¥ï¼Œæ…¢æ…¢è¯´ï¼Œæˆ‘ä¼šåœ¨è¿™é‡Œé™ªä½ ä¸€èµ·å¯»æ‰¾ç­”æ¡ˆ"}
        ]
        # åˆ·æ–°ç½‘é¡µï¼Œè®©ç•Œé¢ç«‹åˆ»å˜å¹²å‡€
        st.rerun()
st.caption("åŸºäº Streamlit å’Œ å¤§æ¨¡å‹ API æ­å»ºçš„æç®€èŠå¤©åº”ç”¨")

# å‡çº§åçš„ä»£ç ï¼šåŠ å…¥ System Prompt å‰§æœ¬
if "messages" not in st.session_state:
    st.session_state.messages = [
        # ğŸŒŸ è¿™é‡Œçš„ "system" å°±æ˜¯ä½ ç»™ AI è®¾å®šçš„ç»ˆæäººè®¾å‰§æœ¬ï¼ˆç”¨æˆ·åœ¨ç½‘é¡µä¸Šæ˜¯çœ‹ä¸è§è¿™å¥è¯çš„ï¼‰
        {"role": "system", "content": "ä½ æ˜¯ä¸€ä½æ¸©å’Œå„’é›…ã€åšå­¦å¤šæ‰çš„è€å¸ˆã€‚æ— è®ºç”¨æˆ·é—®ä»€ä¹ˆé—®é¢˜ï¼Œå“ªæ€•æ˜¯å¾ˆåŸºç¡€çš„ä»£ç æŠ¥é”™ï¼Œä½ éƒ½ä¼šæå…·è€å¿ƒåœ°è§£ç­”ï¼Œè¯­æ°”æ¸©å’Œã€å……æ»¡é¼“åŠ±ã€‚åœ¨è§£é‡Šå¤æ‚æ¦‚å¿µæ—¶ï¼Œä½ å–œæ¬¢å¨“å¨“é“æ¥ï¼Œå¹¶å–„ç”¨é€šä¿—æ˜“æ‡‚çš„ç”ŸåŠ¨æ¯”å–»ã€‚ä½ çš„å›å¤æ€»æ˜¯è®©äººæ„Ÿåˆ°å¦‚æ²æ˜¥é£ã€è±ç„¶å¼€æœ—ã€‚"}, 
        # è¿™æ˜¯ç½‘é¡µä¸Šä¸€æ‰“å¼€æ˜¾ç¤ºçš„å¼€åœºç™½ï¼Œå¯ä»¥é…åˆäººè®¾ä¿®æ”¹ä¸€ä¸‹
        {"role": "assistant", "content": "ä½ å¥½ï¼ŒåŒå­¦ã€‚æ±‚çŸ¥ä¹‹è·¯æ¼«æ¼«ï¼Œéš¾å…ä¼šé‡åˆ°äº›è®¸å›°æƒ‘ã€‚ä¸è¦ç€æ€¥ï¼Œæ…¢æ…¢è¯´ï¼Œæˆ‘ä¼šåœ¨è¿™é‡Œé™ªä½ ä¸€èµ·å¯»æ‰¾ç­”æ¡ˆ"}
    ]
# æŠŠå†å²èŠå¤©è®°å½•å±•ç¤ºåœ¨é¡µé¢ä¸Š
for msg in st.session_state.messages:
    with st.chat_message(msg["role"]):
        st.markdown(msg["content"])

# ==========================================
# 3. è®© AI å¼€å§‹å·¥ä½œ (æ¥æ”¶è¾“å…¥å¹¶ç”Ÿæˆå›å¤)
# ==========================================
# ç½‘é¡µåº•éƒ¨çš„è¾“å…¥æ¡†
if prompt := st.chat_input("è¯·è¾“å…¥ä½ çš„é—®é¢˜..."):
    
    # 1. æŠŠç”¨æˆ·çš„é—®é¢˜æ˜¾ç¤ºåœ¨é¡µé¢ä¸Šï¼Œå¹¶å­˜å…¥å†å²è®°å½•
    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        st.markdown(prompt)

    # 2. å‘¼å«å¤§æ¨¡å‹ï¼Œè·å–å›å¤
    with st.chat_message("assistant"):
        # è¿™é‡Œä½¿ç”¨äº†æµå¼è¾“å‡ºï¼ˆstream=Trueï¼‰ï¼Œå­—ä¼šä¸€ä¸ªä¸€ä¸ªè¹¦å‡ºæ¥
        stream = client.chat.completions.create(
            model="deepseek-chat", # æ›¿æ¢ä¸ºä½ ä½¿ç”¨çš„æ¨¡å‹åç§°
            messages=st.session_state.messages,
            stream=True 
        )
        # ç”¨ st.write_stream æ¥æ”¶å¹¶ç‚«é…·åœ°å±•ç¤ºæ‰“å­—æœºæ•ˆæœ
        response = st.write_stream(stream)
        
    # 3. æŠŠ AI çš„å›å¤ä¹Ÿå­˜å…¥å†å²è®°å½•
    st.session_state.messages.append({"role": "assistant", "content": response})